\label{processing}

Записанные файлы с видеосъемкой этапов проведения эксперимента переписываются на
ПК и обрабатываются, чтобы получить таблицу значений скорости движения конкретного
образца в зависимости от частоты переключения магнитного поля. Для этого с помощью
любой программы просмотра видеоизображений, которая позволяет фиксировать номер
кадра видеосъемки, просматриваются все записи этапов эксперимента, и фиксируются
номера кадров, соответствующие стартовой и конечной положениям образца при его
движении по каналу на фиксированной дистанции. На рисунке \ref{fig:start-stop}
показаны примеры соответствующих кадров.

Далее, полученные данные вводятся в таблицу программы Exel, и по приведенной ниже
формуле \ref{velocity} вычисляется скорость движения образца соответствующая каждому
значению частоты переключения магнитного поля.

\begin{equation}
\label{velocity}
v = \frac{d f_{video}}{n_f - n_s}
\end{equation}

Здесь $v$~-- скорость образца; $d$~-- расстояние между стартовой и конечной позициям
образца; $n_s$~-- номер кадра, соответствующего стартовому положению образца; $n_f$~-- номер
кадра, соответствующего конечному положению образца; $f_{video}$~-- скорость съемки (кадры
в сек).

На рисунке \ref{fig:exp} показан в виде графика пример результата обработки
экспериментальных данных. По оси ординат отложены значения скорости образца в
см/сек, а по оси абсцисс~-- соответствующие частоты переключения магнитного поля в Гц.


\newpage
\begin{figure}
\centerline{а)\ \ \includegraphics[width=256pt]{start}} % и вокруг рисунка  512 x 384  Pixels
\ \\
\centerline{б)\ \ \includegraphics[width=256pt]{finish}} % и вокруг рисунка  512 x 384  Pixels
\caption{Примеры кадров, соответствующих стартовому (a) и конечному (б) положениям образца при его
движении по каналу на фиксированной дистанции}                         %% Нумерация рисунка.Подпись к рисунку.
\label{fig:start-stop}                     %% Метка к этому рисунку.
%\ \\
%\centerline{\includegraphics[166pt,159pt]{image004.bmp}} % и вокруг рисунка
%\caption{Выбор подключения цифровой камеры}                         %% Нумерация рисунка.Подпись к рисунку.
%\label{fig:video}                     %% Метка к этому рисунку.

\end{figure}
\clearpage

Если необходима обработка большого числа экспериментальных видеофайлов записанных при одинаковых
внешних условиях (одинаковое освещение и положение камеры),
имеется возможность автоматической обработки видеофайлов с помощью написанной для этой цели программой.
Принцип работы программы следующий:

\begin{enumerate}

\item На первом этапе производится декодирование видео, приведение к набору кадров
в шкале серого цвета.

\item Затем извлекается область кадра с изображением канала, производится
осреднение освещенности по высоте канала (каждому столбцу пикселей на
изображении ставится в соответствие сумма освещенностей (количества белого
цвета) пикселей столбца).

\item В полученном одномерном массиве ищутся наиболее контрастные переходы
(соответствующие штрихам линейки или границе тела в канале). Из набора
начальных кадров (с неподвижным телом, до включения тока) путем сравнения с
эмпирическим шаблоном (~15 штрихов на равном расстоянии друг от друга)
формируется шкала линейки, выделяется старт и финиш дистанции. Контрастные
переходы, отличные от полученных штрихов шкалы, для кадров с двигающимся
телом означают границы тела. На их основе вычисляется скорость левой границы
тела.

\end{enumerate}

Основная проблема в том, что на качественную работу программы
влияет степень  освещенности и положение камеры (или изменение ее фокусной настройки).
Если от кадра к кадру меняется критическое
значения освещенности (или контрастности), то, например, программа
может принять границу блика на канале за границу тела. Для этого в программе есть
возможность учитывать блики и игнорировать их, но тогда нужно вручную
рассматривать кадры (в любом графическом редакторе, например, Paint), находить место блика
и учитывать его при работе программы.
Кроме того, иногда  требуется изменить внутренние константы алгоритма программы
(например, если конец тела в процессе движения слишком сильно сдвинулся назад при изгибе),
что случается очень редко.

Основной рекомендацией при использовании программы автоматической обработки видеофайлов
является тщательная настройка освещения и положение камеры перед серией экспериментов.
Далее, необходима отладка работы программы на паре тестовых или начальных видеофайлов,
что может быть гарантией, что обработка видеофайлов будет успешной.

\newpage

Формальная последовательность действий при использовании программы при ее удачном выполнении
и правильной настройке камеры следующая:
\begin{enumerate}

\item В папку с программой помещается видеофайл в формате <NAME>.mov (возможна одновременная обработка
нескольких файлов).
\item Запускается исполняемый файл программы~-- process\_video.py.
\item После завершения обработки каждого файла появляется вложенная папка с названием <NAME>\_OK,
внутри которой находится видео-файл, ~15 кадров моментов пересечения телом
штрихов линейки и файл в формате CSV со строкой номеров этих кадров и
подсчитанной скоростью (для вставки строки в EXCEL).

\end{enumerate}

Если в процессе выполнения программы произошла ошибка (не найден момент
пересечения очередного штриха), то в окне командной строки выполнения
программы останется информация о выполнении (номера некоторых кадров с
определенным положением тела), а рядом с видео-файлом появится папка <NAME>
со всеми серыми кадрами (название-номер кадра). Можно просмотреть
интересующий интервал кадров и попытаться диагностировать ошибку.
Отметим, что для обработки одного видеофайла, легче вручную найти кадры старта и финиша.

Программа написана на языке программирования Python, для ее работы необходим установленный
интерпретатор Python, также нужно установить библиотеку PIL
(доступна по адресу \url{http://www.pythonware.com/products/pil/}).
Библиотека ffmpeg использована в виде исполняемого файла ffmpeg.exe,
и доступна по адресу \url{http://ffmpeg.zeranoe.com/builds/},
откуда нужно скачать Latest STATIC build и  распаковать  в папку с программой. 